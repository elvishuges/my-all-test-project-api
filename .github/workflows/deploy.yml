name: Deploy Node.js to EC2

on:
  push:
    branches:
      - main # Ou o nome da sua branch principal

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      EC2_URL: "ec2-54-242-68-24.compute-1.amazonaws.com"
      EC2_USERNAME: "ubuntu"

    steps:
      - name: Setup SSH for EC2
        uses: omarhosny206/setup-ssh-for-ec2@v1.0.0
        with:
          EC2_SSH_PRIVATE_KEY: ${{ env.EC2_SSH_PRIVATE_KEY }}
          EC2_URL: ${{ env.EC2_URL }}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22" # ou 24 se quiser a mais recente

      - name: Install dependencies locally
        run: npm install

      - name: Deploy project to EC2
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_URL << 'EOF'
            # Atualizar pacotes
            sudo apt update -y

            # Instalar Node.js se não existir
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_current.x | sudo -E bash -
              sudo apt install -y nodejs
            fi

            # Instalar PM2 globalmente (se ainda não estiver instalado)
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            # Diretório do app na EC2
            APP_DIR=/home/ubuntu/meu-projeto-node
            mkdir -p $APP_DIR
            cd $APP_DIR

            # Clonar ou atualizar o repositório
            if [ ! -d ".git" ]; then
              git clone https://github.com/elvishuges/my-all-test-project-api.git .
              git checkout main
            else
              git fetch origin main
              git reset --hard origin/main
            fi

            # Instalar dependências
            npm install --production

            # Iniciar ou reiniciar com PM2
            if pm2 list | grep -q "generic-api"; then
              pm2 restart generic-api
            else
              pm2 start index.js --name "generic-api"
            fi

            # Garantir que o PM2 reinicie automaticamente após reboot
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu
          EOF
