name: Deploy Node.js to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      EC2_HOST: ec2-18-208-250-82.compute-1.amazonaws.com
      EC2_USER: ubuntu
      APP_PATH: /home/ubuntu/meu-projeto-node

    steps:
      # 1Ô∏è‚É£ Configurar a chave SSH
      - name: Configurar chave SSH
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      # 2Ô∏è‚É£ Verificar conex√£o
      - name: Testar conex√£o SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST "echo '‚úÖ Conex√£o SSH bem-sucedida!'"

      # 3Ô∏è‚É£ Checkout do reposit√≥rio
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      # 4Ô∏è‚É£ Cache de depend√™ncias do Node.js
      - name: Cache depend√™ncias Node.js
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 5Ô∏è‚É£ Enviar c√≥digo para a EC2 (sincronizado com rsync)
      - name: Copiar arquivos para EC2
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.github' \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./ $EC2_USER@$EC2_HOST:$APP_PATH

      # 6Ô∏è‚É£ Instalar depend√™ncias e reiniciar aplica√ß√£o com PM2
      - name: Instalar depend√™ncias e reiniciar app
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            set -e
            cd $APP_PATH

            echo "üì¶ Instalando depend√™ncias..."
            npm ci --omit=dev

            echo "üèóÔ∏è  Buildando (se existir script build)..."
            if [ -f package.json ] && grep -q "\"build\":" package.json; then
              npm run build
            fi

            echo "üöÄ Iniciando ou reiniciando aplica√ß√£o com PM2..."
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            pm2 start ecosystem.config.js || pm2 restart all || pm2 start index.js --name "meu-projeto"
            pm2 save

            echo "‚úÖ Deploy finalizado com sucesso!"
          EOF
